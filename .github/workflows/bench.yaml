name: bench

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    branches: [main]

jobs:
  bench:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Run benchmarks on PR branch
        run: |
          deno task bench:json > bench-pr.json 2>&1 || true

      - name: Checkout base branch
        run: |
          git checkout ${{ github.event.pull_request.base.sha }}

      - name: Run benchmarks on base branch
        run: |
          deno task bench:json > bench-base.json 2>&1 || true

      - name: Checkout PR branch
        run: |
          git checkout ${{ github.event.pull_request.head.sha }}

      - name: Compare benchmarks and generate report
        id: bench-diff
        run: |
          deno run --allow-read _tools/bench_diff.ts bench-base.json bench-pr.json > bench-report.md

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: "## Benchmark Results"

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: bench-report.md
          edit-mode: replace
